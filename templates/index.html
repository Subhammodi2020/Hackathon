<!DOCTYPE html>
<html>
  <head>
    <title>Employee QR Code System</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      .qr-container {
        margin: 20px 0;
        text-align: center;
      }
      .qr-code {
        max-width: 200px;
        margin: 0 auto;
      }
      .employee-details {
        margin-top: 20px;
      }
    </style>
  </head>
  <body>
    <div class="container mt-5">
      <h1 class="text-center mb-4">Employee QR Code System</h1>

      <div class="row">
        <div class="col-md-6 offset-md-3">
          <div class="card">
            <div class="card-header">
              <ul class="nav nav-tabs card-header-tabs">
                <li class="nav-item">
                  <a
                    class="nav-link active"
                    id="scan-tab"
                    data-bs-toggle="tab"
                    href="#scan"
                    >Scan QR</a
                  >
                </li>
              </ul>
            </div>
            <div class="card-body">
              <div class="tab-content">
                <div class="tab-pane fade show active" id="scan">
                  <div class="mb-3">
                    <label class="form-label">Employee ID</label>
                    <input
                      type="text"
                      class="form-control"
                      id="employeeId"
                      placeholder="Enter Employee ID"
                    />
                  </div>
                  <button class="btn btn-primary" id="generateBtn">
                    Generate QR
                  </button>

                  <div id="qrResult" class="mt-4">
                    <!-- QR Code will be displayed here -->
                  </div>

                  <div
                    id="employeeDetails"
                    class="employee-details"
                    style="display: none"
                  >
                    <h4>Employee Details</h4>
                    <table class="table table-bordered">
                      <tr>
                        <th>Name:</th>
                        <td id="emp-name">-</td>
                      </tr>
                      <tr>
                        <th>Employee ID:</th>
                        <td id="emp-id">-</td>
                      </tr>
                      <tr>
                        <th>Department:</th>
                        <td id="emp-dept">-</td>
                      </tr>
                      <tr>
                        <th>Position:</th>
                        <td id="emp-position">-</td>
                      </tr>
                      <tr>
                        <th>Email:</th>
                        <td id="emp-email">-</td>
                      </tr>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // document
      //   .getElementById("generateBtn")
      //   .addEventListener("click", async function () {
      //     const employeeId = document.getElementById("employeeId").value.trim();
      //     if (!employeeId) {
      //       alert("Please enter an Employee ID");
      //       return;
      //     }

      //     const qrResult = document.getElementById("qrResult");
      //     const employeeDetails = document.getElementById("employeeDetails");

      //     // Show loading state
      //     qrResult.innerHTML = "<p>Generating QR code...</p>";
      //     employeeDetails.style.display = "none";

      //     try {
      //       // First, get the employee details
      //       const response = await fetch(`/employee/${employeeId}`);
      //       if (!response.ok) {
      //         throw new Error("Employee not found");
      //       }

      //       const employee = await response.json();

      //       // Then generate the QR code
      //       const qrResponse = await fetch("/generate_qr_base64", {
      //         method: "POST",
      //         headers: {
      //           "Content-Type": "application/json",
      //         },
      //         body: JSON.stringify({ employee_id: employeeId }),
      //       });

      //       if (!qrResponse.ok) {
      //         throw new Error("Failed to generate QR code");
      //       }

      //       const qrData = await qrResponse.json();

      //       // Display QR code
      //       qrResult.innerHTML = `
      //               <div class="qr-container">
      //                   <h5>Employee QR Code</h5>
      //                   <img src="${qrData.image}" alt="QR Code" class="img-fluid qr-code">
      //                   <div class="mt-2">
      //                       <button class="btn btn-sm btn-outline-primary" onclick="downloadQR('${qrData.image}', '${employeeId}')">
      //                           Download QR Code
      //                       </button>
      //                   </div>
      //               </div>`;

      //       // Display employee details
      //       document.getElementById("emp-name").textContent =
      //         employee.name || "-";
      //       document.getElementById("emp-id").textContent =
      //         employee.id || employeeId;
      //       document.getElementById("emp-dept").textContent =
      //         employee.department || "-";
      //       document.getElementById("emp-position").textContent =
      //         employee.position || "-";
      //       document.getElementById("emp-email").textContent =
      //         employee.email || "-";

      //       employeeDetails.style.display = "block";
      //     } catch (error) {
      //       qrResult.innerHTML = `<div class="alert alert-danger">${error.message}</div>`;
      //       console.error("Error:", error);
      //     }
      //   });


      // In your index.html, update the JavaScript section
      document.getElementById('generateBtn').addEventListener('click', async () => {
          const employeeId = document.getElementById('employeeId').value;
          if (!employeeId) {
              alert('Please enter an employee ID');
              return;
          }

          try {
              // Get employee details
              const response = await fetch(`/employee/${employeeId}`);
              const data = await response.json();
              
              if (data.error) {
                  throw new Error(data.error);
              }

              // Display employee details
              document.getElementById('employeeDetails').innerHTML = `
                  <h3>Employee Details</h3>
                  <p><strong>Name:</strong> ${data.name || 'N/A'}</p>
                  <p><strong>Department:</strong> ${data.department || 'N/A'}</p>
                  <p><strong>Position:</strong> ${data.position || 'N/A'}</p>
                  <p><strong>Email:</strong> ${data.email || 'N/A'}</p>
              `;

              // Get and display QR code
              const qrResponse = await fetch(`/api/qr/${employeeId}`);
              const qrData = await qrResponse.json();
              
              if (qrData.error) {
                  throw new Error(qrData.error);
              }

              const qrImg = document.getElementById('qrCode');
              qrImg.src = qrData.image;
              qrImg.style.display = 'block';

              // Show download button
              const downloadBtn = document.getElementById('downloadBtn');
              downloadBtn.style.display = 'inline-block';
              downloadBtn.onclick = () => {
                  const a = document.createElement('a');
                  a.href = qrData.image;
                  a.download = `qr_${employeeId}.png`;
                  a.click();
              };

          } catch (error) {
              alert(`Error: ${error.message}`);
              console.error('Error:', error);
          }
      });

      // Function to download QR code
      function downloadQR(imageData, filename) {
        const link = document.createElement("a");
        link.href = imageData;
        link.download = `qrcode_${filename}.png`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }
    </script>
  </body>
</html>
